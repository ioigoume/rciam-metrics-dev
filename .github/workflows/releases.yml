name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions üöÄ
on: [push]
env:
  RELEASE_ID: ${GITHUB_RUN_ID} 
jobs:
  deploy:  
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: |
          cd ${{ github.workspace }}/javascript; npm install
      - name: Build React application
        run: |
          cd ${{ github.workspace }}/javascript; CI=false npm run build
      # Share artifact inside workflow
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}/javascript
      - name: Create release branch
        run: git checkout -b rc-${GITHUB_RUN_ID}
      - name: Initialize mandatory git config
        run: |
          git config user.name "GitHub Actions"  
          git config user.email noreply@github.com
      - name: Push new branch
        run: git push origin rc-${GITHUB_RUN_ID}
      - name: Share artifact inside workflow
        uses: actions/upload-artifact@v3
        with:
          name: react-github-actions-build
          path: | 
            ${{ github.workspace }}/javascript/build
            ${{ github.workspace }}/app
            ${{ github.workspace }}/requirements.txt
      - run: echo "üçè This job's status is ${{ job.status }}."
  release:
    runs-on: ubuntu-latest
    # We specify that deploys needs to
    # finish before we create a release
    needs: deploy
    steps:
      # Download previously shared build
      - name: Get artifact
        uses: actions/download-artifact@v3
        with:
          name: react-github-actions-build
      # Zip the build using external action
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: Zip artifact for deployment
        run: zip -r -qq react-github-actions-release-build.zip .
        working-directory: ${{ github.workspace }}
      # Upload as an artifact of the current workflow
      - name: Upload build zip artifact
        uses: actions/upload-artifact@v1
        with:
          name: react-github-actions-release-build.zip
          path: react-github-actions-release-build.zip
      Make official GitHub release which will trigger
      sending the mail with link for access
      - name: Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: react-github-actions-release-build.zip
          body: Release for rc-$RELEASE_ID
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: rc-$RELEASE_ID
      - name: Create Release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          automatic_release_tag: rc-$RELEASE_ID
          prerelease: false
          files: |
            react-github-actions-release-build.zip
          